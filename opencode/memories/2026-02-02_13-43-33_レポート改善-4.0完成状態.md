---
title: "コンパイラ実験レポート改善 - 4.0コード生成の基盤仕組み 完了"
date: "$(date '+%Y-%m-%d %H:%M:%S')"
topics:
  - compiler
  - report
  - codegen
  - section-4-0
summary: "4.0「コード生成の基盤仕組み」をmain.texに追加完了。次は4.1算術演算の詳細化。"
---

# 4.0 完了状態

## 追加したセクション

### \subsection{コード生成の基盤仕組み} \label{sec:codegen_basis}

位置: main.tex L209-298

#### 4つの小節

1. **4.0.1 スタックマシン方式の採用**
   - 採用理由：レジスタ割り当ての複雑さを回避し、実装の確実性を優先
   - メリット：実装がシンプル、理解しやすく、デバッグが容易
   - デメリット：メモリアクセス頻度が増加し、実行性能が低下
   - 考察への言及：第\ref{sec:consideration}章でレジスタ割り当て実験を説明

2. **4.0.2 スタック操作関数（push/pop）**
   - コードを提示（Verbatim環境）
   - push関数：レジスタの値をスタックトップに保存、$spを4バイト減らす
   - pop関数：スタックトップの値をレジスタに読み込み、$spを4バイト増やす
   - 共通化の理由：コードの重複を排除し、可読性を向上
   - 使用箇所26回（算術8、比較12、配列6）

3. **4.0.3 レジスタ割り当てポリシー**
   - $fp: 変数アクセスの基準（関数開始時に固定）
   - $sp: スタックマシンの一時保存領域（演算のたびに変動）
   - $v0: 演算結果および左辺値を格納
   - $v1: 右辺値を一時的に保持（スタックから復帰）

4. **4.0.4 二項演算の共通パターン**
   - 評価順序：右辺→push→左辺→pop→演算命令
   - **重要な試行錯誤**：
     - 最初は左から評価していた
     - 減算で `sub $v0, $v1, $v0` という不自然な命令になった
     - 右から評価に変更して `op $v0, $v0, $v1` が自然に実現

---

## レポートの構成（現在）

### 第4章 コード生成の実装

```
4.0 コード生成の基盤仕組み ← 完了済み
  4.0.1 スタックマシン方式の採用
  4.0.2 スタック操作関数（push/pop）
  4.0.3 レジスタ割り当てポリシー
  4.0.4 二項演算の共通パターン

4.1 算術式のコード生成 ← 未着手（既存内容あり）
4.2 制御構文の翻訳 ← 既存内容あり
4.3 変数と配列のメモリ管理 ← 既存内容あり
```

---

## 次のステップ：4.1 算術演算の詳細化

### 計画している構成

```
4.1 算術演算のコード生成
  4.1.1 加算（add）の実装
  4.1.2 減算（sub）の実装
  4.1.3 乗算（mul）の実装（HI/LOレジスタ）
  4.1.4 除算（div）の実装（HI/LOレジスタ）
```

### 各小節の方針

- 「4.0で説明済みなので詳細は省略」を明記
- 共通パターン（4.0.4）を引用
- 各演算固有のポイントに絞る
  - 加算：基本的な3オペランド命令
  - 減算：右辺先評価の恩恵を受ける例
  - 乗算：mult命令、結果がHI/LOレジスタに格納される
  - 除算：div命令、結果がHI/LOレジスタに格納される

---

## 実装コード（codegen.c）の対応箇所

```c
// L125-131: PLUS_AST
case PLUS_AST:
    walk_ast(n->child->brother,fp);
    push("$v0", fp);
    walk_ast(n->child,fp);
    pop("$v1",fp);
    fprintf(fp,"  add $v0, $v0, $v1\n");
    break;

// L133-139: MINUS_AST
case MINUS_AST:
    walk_ast(n->child->brother,fp);
    push("$v0", fp);
    walk_ast(n->child,fp);
    pop("$v1",fp);
    fprintf(fp,"  sub $v0, $v0, $v1\n");
    break;

// L141-148: MUL_AST
case MUL_AST:
    walk_ast(n->child->brother,fp);
    push("$v0", fp);
    walk_ast(n->child,fp);
    pop("$v1",fp);
    fprintf(fp,"  mult $v0, $v1\n");
    fprintf(fp,"  mflo $v0\n");
    break;

// L150-157: DIV_AST
case DIV_AST:
    walk_ast(n->child->brother,fp);
    push("$v0", fp);
    walk_ast(n->child,fp);
    pop("$v1",fp);
    fprintf(fp,"  div $v0, $v1\n");
    fprintf(fp,"  mflo $v0\n");
    break;
```

---

## 文体要件

- **学生らしい（だ・である調）**
- **学習プロセスを重視**: どのように考えてこの方針にしたか
- **苦労・失敗・改善**: 実装過程での試行錯誤にも触れる
- **4.0を引用**: 「4.0.4で説明した通り」などの言及

---

## 関連ファイル

- final_report/main.tex（レポート本体、L209-298に4.0を追加）
- final_report/docs/改善.md（改善計画）
- c-compiler/src/codegen.c（実装コード）
